<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contact Application - Search</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
  /* Minimal: align table padding with container/card spacing */
  .table thead th, .table tbody td {
    padding: .75rem 1.25rem; /* matches Bootstrap card/form spacing */
    vertical-align: middle;
    white-space: nowrap;     /* prevent mobile wrapping for key columns */
  }

  /* Allow wrapping on very small screens */
  @media (max-width: 575.98px) {
    .table thead th, .table tbody td { white-space: normal; padding: .5rem .75rem; }
  }

  /* Keep Actions column compact */
  #contactTable th:last-child, #contactTable td:last-child {
    width: 130px;
    text-align: center;
  }
  /* show a red star when invalid, and style label/input when "all-invalid" state */
.requiredStar { visibility: hidden; margin-left: 4px; }
.modal-invalid .requiredStar { visibility: visible; }

/* apply Bootstrap-like invalid look to all inputs when modal-invalid */
.modal-invalid .form-control,
.modal-invalid .form-select {
  border-color: red;        /* bootstrap danger */
  box-shadow: 0 0 0 .15rem rgba(220,53,69,.075);
}

/* make labels red */
.modal-invalid .form-label {
  font-weight: 600;
}
.input-error {
  border-color: red !important;
}

.error-text {
  color: red;
  font-size: 12px;
  margin-top: 2px;
}
.input-error {
  border-color: red !important;
}

.error-text {
  color: red;
  font-size: 12px;
  margin-top: 2px;
}

</style>

</head>
<body class="bg-light">

<div class="container py-4">

  <h1 class="mb-4">Contacts</h1>

  <div class="row g-2 align-items-center">

    <!-- Search Bar -->
    <div class="col-md-6">
      <div class="input-group">
        <input type="text" id="basicSearch" class="form-control"
               placeholder="Search by name, mobile, or city...">
        <button class="btn btn-primary" id="basicSearchBtn">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>

    <!-- New Contact + Advanced + CSV in the SAME LINE -->
    <div class="col-md-6 d-flex justify-content-end gap-2">

      <button id="newContactBtn"
              class="btn btn-info d-flex align-items-center gap-2"
              data-bs-toggle="modal" data-bs-target="#addContactModal">
        <i class="bi bi-person-plus-fill"></i> New Contact
      </button>

      <!-- Advanced Search -->
      <button class="btn btn-secondary"
              data-bs-toggle="collapse" data-bs-target="#advancedSearch" id="toggleAdvanced">
        Advanced Search <i id="arrowIcon" class="bi bi-chevron-down"></i>
      </button>

      <!-- CSV Button -->
      <button class="btn btn-success" id="csvButton">
        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
      </button>

    </div>
  </div>

  <!-- ✅ CSV Export Popup Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Export CSV</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body" id="exportMessage"></div>

        <div class="modal-footer d-flex justify-content-between" id="exportButtons"></div>

      </div>
    </div>
  </div>

  <!-- Advanced Search Collapse -->
  <div class="collapse mt-3" id="advancedSearch">
    <div class="card">
      <div class="card-body p-4">
        <div class="row g-3">

          <div class="col-md-4">
            <label class="form-label">Title</label>
            <select id="title" class="form-select">
              <option value="">All</option>
              <option>Mr</option>
              <option>Mrs</option>
              <option>Ms</option>
              <option>Dr</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">First Name <span class="text-danger">*</span></label>
            <input type="text" id="firstName" class="form-control" placeholder="Enter first name">
          </div>

          <div class="col-md-4">
            <label class="form-label">Last Name</label>
            <input type="text" id="lastName" class="form-control" placeholder="Enter last name">
          </div>

          <div class="col-md-4">
            <label class="form-label">Mobile 1 <span class="text-danger">*</span></label>
            <input type="text" id="mobile" class="form-control" placeholder="Enter mobile number">
          </div>

          <div class="col-md-4">
            <label class="form-label">City</label>
            <select id="city" class="form-select">
              <option value="">All</option>
              <option>Delhi</option>
              <option>Pune</option>
              <option>Hyderabad</option>
              <option>Bangalore</option>
              <option>Ahmedabad</option>
              <option>Chennai</option>
              <option>Chandigarh</option>
              <option>Amritsar</option>
              <option>Kolkata</option>
              <option>Lucknow</option>
              <option>Jaipur</option>
              <option>Coimbatore</option>
              <option>Thiruvananthapuram</option>
              <option>Bhubaneswar</option>
              <option>Surat</option>
              <option>Kochi</option>
              <option>Bhopal</option>
              <option>Vijayawada</option>
              <option>Indore</option>
              <option>Nagpur</option>
              <option>Varanasi</option>
              <option>Durgapur</option>
              <option>Kanpur</option>
              <option>Nashik</option>
              <option>Dehradun</option>
              <option>Gurgaon</option>
              <option>Howrah</option>
              <option>Siliguri</option>
              <option>Patna</option>
              <option>Raipur</option>
              <option>Gwalior</option>
              <option>Noida</option>
              <option>Mangalore</option>
              <option>Ranchi</option>
              <option>Shimla</option>
              <option>Allahabad</option>
              <option>Select City</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">State</label>
            <select id="state" class="form-select">
              <option value="">All</option>
              <option>Telangana</option>
              <option>Delhi</option>
              <option>Maharashtra</option>
              <option>Karnataka</option>
              <option>Gujarat</option>
              <option>Tamil Nadu</option>
              <option>Chandigarh</option>
              <option>Punjab</option>
              <option>West Bengal</option>
              <option>Uttar Pradesh</option>
              <option>Rajasthan</option>
              <option>Kerala</option>
              <option>Odisha</option>
              <option>Madhya Pradesh</option>
              <option>Andhra Pradesh</option>
              <option>Uttarakhand</option>
              <option>Haryana</option>
              <option>Bihar</option>
              <option>Chhattisgarh</option>
              <option>Jharkhand</option>
              <option>Himachal Pradesh</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Pincode</label>
            <input type="text" id="pincode" class="form-control" placeholder="Enter pincode">
          </div>

        </div>

        <div class="d-flex justify-content-end gap-3 mt-4">
          <button class="btn btn-success px-4" id="applyFilter">Search</button>
          <button class="btn btn-danger px-4" id="resetFilter">Reset</button>
        </div>

      </div>
    </div>
  </div>

  <!-- TABLE (wrapped in table-responsive) -->
  <div class="table-responsive mt-4">
    <table class="table table-bordered table-striped table-hover table-sm mb-0" id="contactTable">
      <thead class="table-primary">
        <tr>
          <th>Title</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Mobile 1</th>
          <th>Mobile 2</th>
          <th>City</th>
          <th>State</th>
          <th>Pincode</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="contactBody"></tbody>
    </table>
  </div>

  <!-- footer: count + pagination -->
  <div class="d-flex justify-content-between align-items-center mt-3">

    <!-- LEFT SIDE -->
    <div id="accountCount" class="fw-bold text-primary"></div>

    <!-- RIGHT SIDE: Page Size + Pagination -->
    <div class="d-flex align-items-center" style="gap:30px;">

      <!-- Page size dropdown -->
      <div class="d-flex align-items-center" style="margin-right:0;">
        <label class="fw-bold me-1">Page size:</label>
        <select id="pageSizeSelect" class="form-select form-select-sm border-secondary text-secondary fw-bold" style="width:70px; padding:2px 6px;">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="25">25</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
        </select>
      </div>

      <!-- Pagination -->
      <nav>
        <ul class="pagination mb-0" id="pagination"></ul>
      </nav>

    </div>
  </div>

  <!-- Add Contact Modal -->
  <div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Add New Contact</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
<div class="modal-body">
  <div class="row g-2">
    <div class="col-md-4">
      <label class="form-label">Title <span class="requiredStar text-danger">*</span></label>
      <select id="newTitle" class="form-select" data-required="true">
        <option>Mr</option><option>Mrs</option><option>Ms</option><option>Dr</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label">First Name <span class="requiredStar text-danger">*</span></label>
      <input id="newFirst" class="form-control" data-required="true" />
      <div class="error-text" id="err-newFirst" style="display:none">First name is required</div>
    </div>

    <div class="col-md-4">
      <label class="form-label">Last Name <span class="requiredStar text-danger">*</span></label>
      <input id="newLast" class="form-control" data-required="true" />
      <div class="error-text" id="err-newLast" style="display:none">Last name is required</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Mobile 1 <span class="requiredStar text-danger">*</span></label>
      <input id="newMob1" class="form-control" maxlength="10" data-required="true" />
      <div class="error-text" id="err-newMob1" style="display:none">Mobile 1 is required</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Mobile 2</label>
      <input id="newMob2" class="form-control" maxlength="10" />
      <div class="error-text" id="err-newMob2" style="display:none"></div>
    </div>

    <div class="col-md-6">
      <label class="form-label">City <span class="requiredStar text-danger">*</span></label>
      <input id="newCity" class="form-control" data-required="true" />
      <div class="error-text" id="err-newCity" style="display:none">City is required</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">State <span class="requiredStar text-danger">*</span></label>
      <input id="newState" class="form-control" data-required="true" />
      <div class="error-text" id="err-newState" style="display:none">State is required</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Pincode <span class="requiredStar text-danger">*</span></label>
      <input id="newPin" class="form-control" maxlength="6" data-required="true" />
      <div class="error-text" id="err-newPin" style="display:none">Pincode is required</div>
    </div>
  </div>
</div>
        <div class="modal-footer">
          <button class="btn btn-success" id="saveContactBtn">Save Contact</button>
        </div>
      </div>
    </div>
  </div>

</div> <!-- /.container -->
<script>
let contacts = [];
let currentList = [];
let isEditing = false;   // ✅ tells whether we are editing
let editingId = null;   // ✅ stores MongoDB _id


// ✅ Load contacts from REST API (GET)
fetch("http://localhost:5000/api/contacts")
  .then(res => res.json())
  .then(data => {
    contacts = data;
    currentList = contacts;
    displayContacts(contacts);
  })
  .catch(err => console.log("Mongo fetch error:", err));


const contactBody = document.getElementById("contactBody");
const pagination = document.getElementById("pagination");

let currentPage = 1;
let pageSize = 10; 
// REPLACE your existing displayContacts(list) with this (keeps same behavior)
function displayContacts(list) {
  contactBody.innerHTML = "";

  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const paginatedData = list.slice(start, end);

  // pass list to updateAccountCount so it does not rely on globals
  updateAccountCount(list);

  paginatedData.forEach(c => {
    contactBody.innerHTML += `
      <tr>
        <td>${c.title}</td>
        <td>${c.firstName}</td>
        <td>${c.lastName}</td>
        <td>${c.mobile1}</td>
        <td>${c.mobile2}</td>
        <td>${c.address?.city || ""}</td>
        <td>${c.address?.state || ""}</td>
        <td>${c.address?.pincode || ""}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" onclick="startEditContact('${c._id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteContact('${c._id}')">Delete</button>
        </td>
      </tr>`;
  });

  createPagination(list.length);
}


function createPagination(totalItems) {
  const pageCount = Math.ceil(totalItems / pageSize);
  pagination.innerHTML = "";

  pagination.innerHTML += `
    <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
      <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Prev</a>
    </li>`;

  for (let i = 1; i <= pageCount; i++) {
    pagination.innerHTML += `
      <li class="page-item ${currentPage === i ? "active" : ""}">
        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
      </li>`;
  }

  pagination.innerHTML += `
    <li class="page-item ${currentPage === pageCount ? "disabled" : ""}">
      <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
    </li>`;
}

function changePage(page) {
  currentPage = page;
  displayContacts(currentList);
}

// --------------------------------------------
// SEARCH BUTTON → CLEAR BUTTON SYSTEM (FINAL)
// --------------------------------------------

const searchBtn = document.getElementById("basicSearchBtn");
const searchField = document.getElementById("basicSearch");

// Change button to CLEAR mode
function activateClearMode() {
  searchBtn.classList.remove("btn-primary");
  searchBtn.classList.add("btn-danger");
  searchBtn.innerHTML = '<i class="bi bi-x-lg me-1"></i> Clear';

  searchBtn.onclick = () => {
    searchField.value = "";

    // Reload ALL contacts from backend (only update master `contacts` here)
    fetch("http://localhost:5000/api/contacts")
      .then(res => {
        if (!res.ok) throw new Error("GET all returned " + res.status);
        return res.json();
      })
      .then(data => {
        // update the master list so add/edit/delete still work as expected
        contacts = data;
        // render the fresh master list (not via currentList global)
        currentPage = 1;
        displayContacts(contacts);
        resetToSearchMode();
        console.log("Reloaded master contacts from backend (clear).");
      })
      .catch(err => {
        console.error("Reload error:", err);
        alert("Reload failed. Please try again.");
      });
  };
}


// Change button to SEARCH mode
function resetToSearchMode() {
  searchBtn.classList.remove("btn-danger");
  searchBtn.classList.add("btn-primary");
  searchBtn.innerHTML = '<i class="bi bi-search me-1"></i> Search';
  searchBtn.onclick = doSearch;
}

// doSearch()
function doSearch() {
  const text = searchField.value.trim();
  if (text === "") return;

  // call backend search API and use local variable only
  fetch(`http://localhost:5000/api/contacts/search?q=${encodeURIComponent(text)}`)
    .then(res => {
      if (!res.ok) throw new Error("Search API returned " + res.status);
      return res.json();
    })
    .then(searchResults => {
      // render results (local variable) WITHOUT overwriting contacts/currentList
      currentPage = 1;
      displayContacts(searchResults);
      // turn button to CLEAR mode (clear will reload master list)
      activateClearMode();
      // optional: log so you can see the search result quickly in console
      console.log("Search results (local):", searchResults);
    })
    .catch(err => {
      console.error("Search API error:", err);
      alert("Search failed. Please try again.");
    });
    console.log("Search requested for:", text);

}

// Initial button click = search
searchBtn.onclick = doSearch;


document.getElementById("basicSearch").addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    document.getElementById("basicSearchBtn").click();
  }
});



document.getElementById("applyFilter").addEventListener("click", () => {
  const title = document.getElementById("title").value.trim().toLowerCase();
  const first = document.getElementById("firstName").value.trim().toLowerCase();
  const last = document.getElementById("lastName").value.trim().toLowerCase();
  const mobile = document.getElementById("mobile").value.trim();
  const city = document.getElementById("city").value.trim().toLowerCase();
  const state = document.getElementById("state").value.trim().toLowerCase();
  const pin = document.getElementById("pincode").value.trim();

  currentList = contacts.filter(c =>
    (title === "" || c.title.toLowerCase().includes(title)) &&
    (first === "" || c.firstName.toLowerCase().includes(first)) &&
    (last === "" || c.lastName.toLowerCase().includes(last)) &&
    (mobile === "" || c.mobile1.includes(mobile) || c.mobile2.includes(mobile)) &&
    (city === "" || c.address.city.toLowerCase().includes(city)) &&
    (state === "" || c.address.state.toLowerCase().includes(state)) &&
    (pin === "" || c.address.pincode.includes(pin))
  );

  currentPage = 1;
  displayContacts(currentList);
});


document.getElementById("resetFilter").addEventListener("click", () => {
  document.querySelectorAll("#advancedSearch input, #advancedSearch select").forEach(e => e.value = "");
  currentList = contacts;
  currentPage = 1;
  displayContacts(currentList);
});
const advPanel = document.getElementById("advancedSearch");
const arrowIcon = document.getElementById("arrowIcon");

advPanel.addEventListener('shown.bs.collapse', () => {
  arrowIcon.classList.replace("bi-chevron-down", "bi-chevron-up");
});

advPanel.addEventListener('hidden.bs.collapse', () => {
  arrowIcon.classList.replace("bi-chevron-up", "bi-chevron-down");
});

// It now accepts the list you want to show counts for.
function updateAccountCount(list) {
  const box = document.getElementById("accountCount");
  const masterTotal = contacts.length; // master count (global)

  // if list === contacts (same reference or same length) we show Total contacts
  if (list === contacts || list.length === masterTotal) {
    box.innerHTML = `Total contacts <b>${masterTotal}</b>`;
  } else {
    box.innerHTML = `Found <b>${list.length}</b> Contacts out of <b>${masterTotal}</b>`;
  }
}

function downloadCSV(list, filename) {
  let csv = "Title,First Name,Last Name,Mobile1,Mobile2,City,State,Pincode\n";

  list.forEach(c => {
    csv += `${c.title},${c.firstName},${c.lastName},${c.mobile1},${c.mobile2},${c.address.city},${c.address.state},${c.address.pincode}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
function updateCSVPopup() {
  const box = document.getElementById("exportButtons");
  const message = document.getElementById("exportMessage");

  if (currentList.length === contacts.length) {
    // No search applied → no message
    message.innerHTML = "";

    box.innerHTML = `
      <button class="btn btn-primary" onclick="exportAll()" data-bs-dismiss="modal">
        Export all contacts
      </button>
    `;
  } else {
    // Search applied → show message + both buttons
    message.innerHTML = `<p>Select what you want to export:</p>`;

    box.innerHTML = `
      <button class="btn btn-outline-primary" onclick="exportCurrent()" data-bs-dismiss="modal">
        Export current results
      </button>

      <button class="btn btn-primary" onclick="exportAll()" data-bs-dismiss="modal">
        Export all contacts
      </button>
    `;
  }
}


// ✅ Export Only Current Search/Page Results
function exportCurrent() {
  downloadCSV(currentList, "Filtered_Contacts.csv");
}

// ✅ Export ALL Master Contacts
function exportAll() {
  downloadCSV(contacts, "All_Contacts.csv");
}
updateCSVPopup()

// Load page size from localStorage
let savedSize = localStorage.getItem("pageSize");
if (savedSize !== null) {
  pageSize = Number(savedSize);
  document.getElementById("pageSizeSelect").value = savedSize;
}   

// Save page size when user changes it
document.getElementById("pageSizeSelect")
.addEventListener("change", function () {
  pageSize = Number(this.value);
  localStorage.setItem("pageSize", pageSize);
  currentPage = 1;
  displayContacts(currentList);
});
// -----------------------------
// EDIT CONTACT FLOW (USING BACKEND)
// -----------------------------
function startEditContact(id) {
  // Call backend to get one contact by ID
  fetch(`http://localhost:5000/api/contacts/${id}`)
    .then(res => {
      if (!res.ok) {
        throw new Error("Not found");
      }
      return res.json();
    })
    .then(contact => {
      // mark as edit mode
      isEditing = true;
      editingId = id;

      // fill modal fields
      document.getElementById("newTitle").value = contact.title || "";
      document.getElementById("newFirst").value = contact.firstName || "";
      document.getElementById("newLast").value = contact.lastName || "";
      document.getElementById("newMob1").value = contact.mobile1 || "";
      document.getElementById("newMob2").value = contact.mobile2 || "";

      const addr = contact.address || {};
      document.getElementById("newCity").value = addr.city || "";
      document.getElementById("newState").value = addr.state || "";
      document.getElementById("newPin").value = addr.pincode || "";

      // change title + button text for edit mode
      document.getElementById("saveContactBtn").innerText = "Update Contact";
      document.querySelector("#addContactModal .modal-title").innerText = "Edit Contact";

      // open modal
      new bootstrap.Modal(
        document.getElementById("addContactModal")
      ).show();
    })
    .catch(err => {
      console.error("Edit load error:", err);
      alert("Unable to load contact for editing");
    });
}

// -----------------------------
// DELETE CONTACT FLOW
// -----------------------------
function deleteContact(id) {
  if (!confirm("Are you sure you want to delete this contact?")) return;

  fetch(`http://localhost:5000/api/contacts/${id}`, {
    method: "DELETE"
  })
    .then(res => res.json())
    .then(result => {
      if (result.success) {
    contacts = contacts.filter(c => c._id !== id);
    currentList = [...contacts]; 
    displayContacts(currentList);

    // ✅ SHOW DELETE SUCCESS TOAST
    showToast("✔ Contact deleted successfully!");

} else {
    alert("Delete failed");
}

    })
    .catch(err => {
      console.error(err);
      alert("Server error while deleting");
    });
}
function showToast(message) {
  // set dynamic message
  document.getElementById("toastMessage").innerText = message;

  // show bootstrap toast
  const toastEl = document.getElementById("successToast");
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}
function validateModalRequiredFields() {
  const modal = document.getElementById("addContactModal");
  const mc = modal.querySelector(".modal-content");
  const requiredEls = Array.from(modal.querySelectorAll("[data-required='true']"));
  let anyEmpty = false;

  requiredEls.forEach(el => {
    const val = (el.value || "").toString().trim();
    const errEl = document.getElementById("err-" + el.id);
    if (!val) {
      anyEmpty = true;
      el.classList.add("is-invalid", "input-error");
      if (errEl) { errEl.style.display = "block"; }
    } else {
      el.classList.remove("is-invalid", "input-error");
      if (errEl) { errEl.style.display = "none"; }
    }
  });

  if (anyEmpty) {
    mc.classList.add("modal-invalid");
    return false; // invalid
  } else {
    mc.classList.remove("modal-invalid");
    return true; // valid
  }
}

// When opening the modal we should clear previous invalid styling
document.getElementById("newContactBtn").addEventListener("click", () => {
  const modalEl = document.getElementById("addContactModal");
  const mc = modalEl.querySelector(".modal-content");
  mc.classList.remove("modal-invalid");
  modalEl.querySelectorAll("[data-required='true']").forEach(el => el.classList.remove("is-invalid"));
  // reset editing state UI if needed
  isEditing = false;
  editingId = null;
  document.getElementById("saveContactBtn").innerText = "Save Contact";
  document.querySelector("#addContactModal .modal-title").innerText = "Add New Contact";
});

// Also clear styling when user manually edits a field (immediate feedback)
document.querySelectorAll("#addContactModal [data-required='true']").forEach(el => {
  el.addEventListener("input", () => {
    el.classList.remove("is-invalid");
    // if all fields now have value, remove modal-invalid
    validateModalRequiredFields(); // will remove modal-invalid if all filled
  });
});

// -----------------------------
// AFTER SAVE / UPDATE COMMON RESET
// -----------------------------
function afterSaveReset() {
  // Decide message BEFORE resetting isEditing
  const message = isEditing
    ? "✔ Contact updated successfully!"
    : "✔ New contact added successfully!";

  // 1) Refresh table
  currentList = contacts;
  displayContacts(currentList);

  // 2) Clear form fields in the modal
  document.querySelectorAll("#addContactModal input").forEach(el => el.value = "");
  document.getElementById("newTitle").selectedIndex = 0; // reset dropdown to first option

  // 3) Close modal
  document.querySelector("#addContactModal .btn-close").click();

  // 4) Reset editing state
  isEditing = false;
  editingId = null;

  // 5) Reset modal title & button text
  document.getElementById("saveContactBtn").innerText = "Save Contact";
  document.querySelector("#addContactModal .modal-title").innerText = "Add New Contact";

  // 6) Show toast
  showToast(message);
}

// -----------------------------
// SAVE / UPDATE CONTACT BUTTON
// -----------------------------
document.getElementById("saveContactBtn").addEventListener("click", () => {
  // 1) Validate required fields shown in modal
  const valid = validateModalRequiredFields();
  if (!valid) return; // stop if some required fields are empty

  // 2) Build payload
  const contactData = {
    title: document.getElementById("newTitle").value,
    firstName: document.getElementById("newFirst").value.trim(),
    lastName: document.getElementById("newLast").value.trim(),
    mobile1: document.getElementById("newMob1").value.trim(),
    mobile2: document.getElementById("newMob2").value.trim(),
    address: {
      city: document.getElementById("newCity").value.trim(),
      state: document.getElementById("newState").value.trim(),
      pincode: document.getElementById("newPin").value.trim()
    }
  };

  // 3) Final sanity check (you already have validate, but keep this)
  if (!contactData.firstName || !contactData.mobile1) {
    alert("First Name and Mobile are required");
    return;
  }

  // 4) Decide Edit or Add
  if (isEditing && editingId) {
    // Update existing contact
    fetch(`http://localhost:5000/api/contacts/${editingId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(contactData)
    })
      .then(res => {
        if (!res.ok) throw new Error("Update failed: " + res.status);
        return res.json();
      })
      .then(result => {
        // Expect server to return { success: true, contact: updatedContact }
        if (result && result.success && result.contact) {
          // update local master list
          const index = contacts.findIndex(c => c._id === editingId);
          if (index !== -1) contacts[index] = result.contact;
          afterSaveReset();
        } else {
          throw new Error("Unexpected update response");
        }
      })
      .catch(err => {
        console.error("PUT error:", err);
        alert("Update failed. See console for details.");
      });
  } else {
    // Create new contact
    fetch("http://localhost:5000/api/contacts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(contactData)
    })
      .then(res => {
        if (!res.ok) throw new Error("Save failed: " + res.status);
        return res.json();
      })
      .then(result => {
        // Expect server to return { success: true, contact: savedContact }
        if (result && result.success && result.contact) {
          contacts.push(result.contact);   // keep local master list
          afterSaveReset();
        } else {
          throw new Error("Unexpected save response");
        }
      })
      .catch(err => {
        console.error("POST error:", err);
        alert("Save failed. See console for details.");
      });
  }
});

document.getElementById("exportModal")
  .addEventListener("show.bs.modal", updateCSVPopup);
document.getElementById("csvButton").addEventListener("click", function () {

  // If no search → directly download ALL contacts
  if (currentList.length === contacts.length) {
    exportAll();
    return;
  }

  // If search applied → open popup
  let modal = new bootstrap.Modal(document.getElementById("exportModal"));
  updateCSVPopup();
  modal.show();
});
       
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3 ">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">
        ✔ New Contact Updated Successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

</body>
</html>